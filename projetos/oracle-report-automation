import oracledb
import getpass
import os
from datetime import datetime
from openpyxl import Workbook
from email_com_anexo import enviar_email_com_anexo

print("--- INICIANDO ROB√î DE RELAT√ìRIO DE SAL√ÅRIOS ---")


DB_USER = # user db
DB_DSN = # 


connection = None
cursor = None
try:
    db_password = getpass.getpass(prompt=f'Digite a senha do usu√°rio {DB_USER} do Oracle: ')
    print(f"\nüîå Conectando ao banco de dados Oracle ({DB_DSN})...")
    connection = oracledb.connect(user=DB_USER, password=db_password, dsn=DB_DSN)
    print("‚úÖ Conex√£o bem-sucedida!")
    cursor = connection.cursor()

    
    sql_query = """
        SELECT first_name, last_name, job_id, salary
        FROM employees
        WHERE (job_id LIKE '%_MGR' OR job_id LIKE '%_REP') 
          AND salary > 8000                           
        ORDER BY salary DESC
    """

    print("\nüîç Executando a consulta SQL...")
    cursor.execute(sql_query)
    print("‚úÖ Consulta executada.")

    
    print("üìä Coletando os resultados...")

    resultados = cursor.fetchall()
    print(f"‚úÖ {len(resultados)} registros encontrados.")

    print("‚öôÔ∏è Gerando o relat√≥rio Excel...")
    wb = Workbook()  
    ws = wb.active 
    ws.title = "Relatorio Salarios Altos"  # Renomeia a planilha

    cabecalho = ["Nome", "Sobrenome", "Cargo", "Sal√°rio"]
    ws.append(cabecalho)
    print(" - Cabe√ßalho adicionado.")

    for linha_de_dados in resultados:
        ws.append(linha_de_dados)

    print(f" - {len(resultados)} linhas de dados adicionadas.")

    
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    nome_arquivo_excel = f"relatorio_salarios_{timestamp}.xlsx"

    wb.save(nome_arquivo_excel)
    print(f"‚úÖ Relat√≥rio salvo com sucesso como '{nome_arquivo_excel}'!")

    caminho_completo_arquivo = os.path.abspath(nome_arquivo_excel)


    enviar_email_com_anexo('hpirola@gmail.com', 'Relat√≥rio Sal√°rios Altos',
                           'Segue em anexo o relat√≥rio solicitado', caminho_completo_arquivo)



except Exception as e:
    print(f"‚ùå Erro Cr√≠tico: Ocorreu um erro durante a execu√ß√£o.")
    print(f"   Detalhe do erro: {e}")

finally:
    if cursor:
        cursor.close()
        print("\nüßπ Cursor fechado.")
    if connection:
        connection.close()
        print("üîå Conex√£o com o banco de dados fechada.")

print("\n--- ROB√î FINALIZADO ---")
